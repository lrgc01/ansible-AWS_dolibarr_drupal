This is the README file

----------------------------------------------------------------------
BEFORE ANYTHING
----------------------------------------------------------------------

In the work linux box it should have installed ansible, pip and boto. 
This list below works fine in ubuntu 16.04 (xenial) and debian 9 
(stretch) although other versions may work as well:

ansible  2.6.3 (from ppa source)
python3  2.7.13
pip 18	

These below is a python lib list defined in the role base_AWS vars 
in which pip ansible module will try to install:
boto3    1.9.0
boto     2.49.0
botocore 1.12.0

AWS RDS instances have some issues with python3 (or boto??), so used 
python2.

----------------------------------------------------------------------
GENERAL STRUCTURE
----------------------------------------------------------------------
Basically an ansible with some external configs to SSH access - check 
all.sh

The inventory is “host” as used by the main playbook YAML file, 
Drupal.yml

 - Files:

   - hosts - inventory for the Drupal + civicrm site

   - group_vars/server2.yml - look for every var definition here

   - Drupal.yml - main playbook to get Drupal + civicrm up and 
     running

   - AWS.yml - playbook used to build server, DB instance, sec 
     groups, etc.

   - base_AWS.yml - this playbook try to install basics like boto*

   - removeDrupal.yml - just to clean the server and restart 
     Drupal.yml later

   - all.sh - shell used to build everything including AWS (off by 
     now) together with some SSH base configs

   - aws.sh - just to run AWS playbook

   - drupal.sh - just to run Drupal playbook

   - uninst.sh - runs the playbook to clean the server in hosts 
     inventory (removeDrupal.yml)

 - Folder hierarchy (roles):

   - roles/
   - roles/common
   - roles/inst_Drupal
   - roles/uninst_Drupal
   - roles/AWS
   - roles/base_AWS
   - roles/*/{defaults,tasks,vars,templates,handlers}

 - Other folders:

   - group_vars - from ansible best practices - define vars for 
     each server in an inventory - the priority definition

   - facts.d - all data from AWS after deploying the platform

   - conf.d - SSH files built by AWS playbook - mandatory

   - test - self explanatory - unused by now

   - secret - sensitive data

 - Other files:

   - conf.d/linux-key.pem - The key to SSH to lrgc01.uk.to

   - conf.d/ssh_config - SSH client config with hostname and keypath

----------------------------------------------------------------------
BASIC RUNNING (helped by shell scripts)
----------------------------------------------------------------------

Probably the server (here named server2) is up and running. A first 
run of the playbook might be right to check it, as soon as all 
returns "ok".

Just do:

	prompt$ sh all.sh

To destroy just the server and start again:

	prompt$ sh uninst.sh

And again you may run the first shell script to start over:

	prompt$ sh all.sh

----------------------------------------------------------------------
EXTRA VARIABLES SUPPLIED (--extra-vars) AND CURRENT CHOICES
----------------------------------------------------------------------

 - gather_y_n: false
   Up to now there is no need
 
 - update_cache_y_n: yes
   The module apt uses this variable. It's off in the script for a 
   while to speed things.

 - purge_y_n: false
   When uninstalling a package we may choose to purge

 - autoremove_y_n: false
   The same as above, we may uninstall the whole dependency tree

----------------------------------------------------------------------
VARIABLES OF MAIN INTEREST IN group_vars/server2.yml
----------------------------------------------------------------------

 - www_basedir: if using other than the default /var/www.

 - web_service: if using other package than nginx.

 - remove_list: when removing, if not using nginx nor mysql, should 
   alter here.

 - cert_base_path and key_base_path: change according to your needs.

 - cert_params_hash{C, ST, L, O, OU, etc}: change according to your 
   location.

 - drupal_version: in a future upgrade

 - drupal_basename: base site name within web rootdir.

 - db_list{admuser, admpass, host, user, pass, etc}: change to fit 
   your servers.

 - composer_required: the same as for drupal_version above - future 
   upgrade.

 - civicrm_download_url: when upgrading civicrm module.

 - drupal_private_files_dir and civicrm_extensions_dir: you may 
   choose any folder location.

----------------------------------------------------------------------
TEMPLATES
----------------------------------------------------------------------

All of them are mandatory to be checked. Templates are very particular 
to one site. They can be found here:

 - roles/inst_Drupal/templates

And

 - roles/AWS/templates

for AWS playbook. It defines the ssh_config.

----------------------------------------------------------------------
THE PLAYBOOKs
----------------------------------------------------------------------
Here the output of "ansible-playbook -i hosts --list-tasks Drupal.yml" 
command:

----
playbook: Drupal.yml

  play #1 (server2): server2    TAGS: []
    tasks:
      inst_Drupal : Update cache and upgrade -------------------------- TAGS: [update_repository]
      inst_Drupal : Install Drupal dependencies ----------------------- TAGS: [drupal_site, install_dep_pkg]
      inst_Drupal : Set composer required pack ------------------------ TAGS: [drupal_site]
      inst_Drupal : Ensure directories all_descriptor_list.types=dir -- TAGS: [config_files, deploy_templates, drupal_site]
      inst_Drupal : Create admin users for drupal/site ---------------- TAGS: [drupal_site, git_config]
      inst_Drupal : Retrieve priv key from git user ------------------- TAGS: [git_config]
      inst_Drupal : Fill in authorized_keys to git user --------------- TAGS: [git_config]
      inst_Drupal : Grant repodir permissions to git user ------------- TAGS: [git_config]
      inst_Drupal : Create some git projects on server ---------------- TAGS: [git_config]
      inst_Drupal : Set php.ini file ---------------------------------- TAGS: [config_files, config_php_files, deploy_templates]
      inst_Drupal : Remove undesired files (absent in item.types) ----- TAGS: [config_files, deploy_templates]
      inst_Drupal : Deploy templates all_descriptor_list.types=tmpl --- TAGS: [config_files, deploy_templates]
      inst_Drupal : Make proper links all_descriptor_list.types=link -- TAGS: [config_files, deploy_templates]
      inst_Drupal : Upload cert and key files if needed --------------- TAGS: [config_files, key_cert_copy_only, ssl_certificate]
      inst_Drupal : Ensure web service is restarted and enabled ------- TAGS: [config_files, config_php_files, deploy_templates, install_dep_pkg]
      inst_Drupal : Generate private key for account and csr ---------- TAGS: [ssl_certificate]
      inst_Drupal : Create CSR certificate ---------------------------- TAGS: [ssl_certificate]
      inst_Drupal : Create ACME account with respective email --------- TAGS: [ssl_certificate]
      inst_Drupal : Create certificate - 1st step challenge ----------- TAGS: [ssl_certificate]
      inst_Drupal : Create directory structure for challenge ---------- TAGS: [ssl_certificate]
      inst_Drupal : Copy resource to web site to complete the 2nd step  TAGS: [ssl_certificate]
      inst_Drupal : Create certificate - 2nd step challenge -get certs- TAGS: [ssl_certificate]
      inst_Drupal : Copy new cert and key to web server's place ------- TAGS: [ssl_certificate]
      inst_Drupal : Download cert and key files if needed ------------- TAGS: [key_cert_copy_only, ssl_certificate]
      inst_Drupal : Create DBs on respective hosts -------------------- TAGS: [create_databases, databases]
      inst_Drupal : Grant user privileges in DBs ---------------------- TAGS: [databases, grant_privileges]
      inst_Drupal : Download Drupal using drush pm-download (dl) ------ TAGS: [drupal_site]
      inst_Drupal : Download and extract civiCRM ---------------------- TAGS: [drupal_site]
      inst_Drupal : Install Drupal site using drush site-install (si) - TAGS: [drupal_site]
      inst_Drupal : Install CiviCRM module with drush civicrm-install - TAGS: [drupal_site]
      inst_Drupal : Enable some modules with drush -------------------- TAGS: [drupal_site]
      inst_Drupal : Run pm-update to update database if necessary ----- TAGS: [drupal_site]
      inst_Drupal : Deploy Drupal specific templates ------------------ TAGS: [deploy_templates, drupal_site]
      inst_Drupal : Adjust drupal sites and core permissions ---------- TAGS: [drupal_site]
      inst_Drupal : Set variables in settings.php of drupal/civicrm --- TAGS: [drupal_site]
      inst_Drupal : Ensure services are started and enabled ----------- TAGS: [install_dep_pkg]
----

The hiphens o minus signs are used just to make the output easier to 
understand.

Everything is based in few distinct blocks as can be noted in 
roles/inst_Drupal/tasks folder:

	main.yml

which includes:

	10-base.yml
	20-siteconfig.yml
	30-ssl_certificate.yml
	40-database.yml
	50-drupal.yml
	90-last.yml

They are almost self explanatory, but the idea is to prepare the 
environment with the base packages with 01-base, then configure
the mininal nginx with SSL in 02-siteconfig. The 2 step challenge 
certificate in 03-ssl_certficate needs a web server. The 
04-database is almost independent and could be the 2nd pass,
for example, but 04 is fine. Of course Drupal depends on all
these things before. 06-last is a final check to keep services
up - may possibly be omitted.

And now the AWS playbook:

----
playbook: AWS.yml

  play #1 (localhost): localhost        TAGS: []
    tasks:
      AWS : Ensure aws config dir ------------- TAGS: [base_config]
      AWS : Set AWS config ini style file ----- TAGS: [base_config]
      AWS : Gather default VPC facts ---------- TAGS: [create_aws_instances, create_ec2_instances, create_security_groups, gather_default_vpc]
      AWS : Ensure base output dir ------------ TAGS: [create_aws_instances, create_ec2_instances, create_security_groups, gather_default_vpc]
      AWS : Copy default VPC facts ------------ TAGS: [gather_default_vpc]
      AWS : Gather default subnets ------------ TAGS: [create_aws_instances, create_ec2_instances, create_security_groups, gather_default_vpc]
      AWS : Copy default subnets facts -------- TAGS: [gather_default_vpc]
      AWS : Create security groups ------------ TAGS: [change_state_all_ec2_instances, change_state_all_instances, create_aws_instances, create_ec2_instances, create_rds_instances, create_security_groups]
      AWS : Create EC2 key pairs -------------- TAGS: [create_aws_instances, create_ec2_instances, create_key_pairs, create_rds_instances]
      AWS : Create EC2 instances -------------- TAGS: [create_aws_instances, create_ec2_instances]
      AWS : Create RDS instances -------------- TAGS: [create_aws_instances, create_rds_instances]
      AWS : Reboot RDS instance by name ------- TAGS: [reboot_instance, reboot_rds_instance]
      AWS : Start/stop EC2 instances by tags -- TAGS: [change_state_ec2_instance, change_state_instance]
      AWS : Start/stop all EC2 instances ------ TAGS: [change_state_all_ec2_instances, change_state_all_instances]
      AWS : Delete RDS instance by name ------- TAGS: [delete_aws_instances, delete_rds_instances]
      AWS : Delete EC2 instances -------------- TAGS: [delete_aws_instances, delete_ec2_instances]
      AWS : Remove key pair by its name ------- TAGS: [delete_keys]
      AWS : Copy security groups facts -------- TAGS: [change_state_all_ec2_instances, change_state_all_instances, create_aws_instances, create_ec2_instances, create_rds_instances, create_security_groups]
      AWS : Gather EC2 instances facts -------- TAGS: [change_state_all_ec2_instances, change_state_all_instances, create_aws_instances, create_ec2_instances, gather_ec2]
      AWS : Copy EC2 instances facts ---------- TAGS: [change_state_all_ec2_instances, change_state_all_instances, create_aws_instances, create_ec2_instances, gather_ec2]
      AWS : Copy EC2 instances IP/DNS --------- TAGS: [change_state_all_ec2_instances, change_state_all_instances, create_aws_instances, create_ec2_instances, gather_ec2]
      AWS : Deploy templates for inventory ---- TAGS: [config_ansible_host_file, config_files]
----

For now it is only tested to create just one server and one DB 
instance, although it might suggest otherwise when looking
inside its configs. 

In roles/AWS/vars/main.yml you may define a list of keys to be
created - they you be downloaded on creation. Also may specify 
a list of different security group to set.

May stop and start an instance, except for DB which is not 
implemented bu AWS services. In this case, the public IP
will change. Use with parsimony.

All instances facts will be copied to facts.d subdir - even
the IP address when changing.

The secret subdir contains the sensitive data to access AWS endpoints.

----------------------------------------------------------------------
PLAYING WITH THE BOOK
----------------------------------------------------------------------

To run each playbook some extra-vars are needed as summarized above. 
A shell script with some definitions must be settled:

This is the expected header in each shell script:

-----
#!/bin/sh

PLAYDIR="`dirname $0`"

cd "$PLAYDIR"

BASEDIR="`pwd`"
CONFDIR="${BASEDIR}/conf.d"
SSHCONF="${CONFDIR}/ssh_config"

export BASEDIR CONFDIR SSHCONF

export DISPLAY_SKIPPED_HOSTS="false"

export ANSIBLE_SSH_ARGS="-C -o ControlMaster=auto -o ControlPersist=60s -F ${SSHCONF}"
-----

And this is the playbook command itself:

	ansible-playbook --extra-vars "basedir=${BASEDIR} confdir=${CONFDIR} sshconf=${SSHCONF}" _PLAYBOOK_.yml

As explained above, some other extra-vars may be used, but all have 
their own default values already defined in common/defaults/main.yml
of in PLAYBOOK/vars/main.yml below the roles subdir.

Note that group_vars/_SERVER_GROUP_.yml is the main variable file.

It is possible to run just the git parts:

(after the shell script header!!)
$ ansible-playbook \ 
    --extra-vars \
    "basedir=${BASEDIR} confdir=${CONFDIR} sshconf=${SSHCONF}" \
    --tags "git_config" \
    Drupal.yml

----------------------------------------------------------------------
GIT 
----------------------------------------------------------------------
The simplest way to build a git server is with ssh and a pair of keys.

The playbook creates the git user, the repository outside git homedir 
and can create projects from the variable named project_list 
in group_vars/server2.yml file.

Find the private key to connect in 

	conf.d/git_priv_key 

and use it in you ~/.ssh/config. A simple example will look like:

----
Host lrgc01.uk.to
User git
ConnectTimeout 600
Compression yes
IdentityFile ~/.ssh/git_priv_key
----

Then move to a more clean directory and try:
	git clone ssh://git@lrgc01.uk.to/repos/test.git

It should retrieve the complete repository of this ansible job 
including this README file.
